---
title: "Data_Preprocessing"
author: "Arturo"
date: "2025-12-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE
)
```


```{r libraries, echo = FALSE}
library(dplyr)
library(ggplot2)
library(stringr)
library(knitr)
library(tidyverse)
```


```{r loading data, echo = FALSE}
steam = read.csv("data/kaggle_march2025_full.csv")
```


```{r info of the dataset, echo = FALSE}
str(steam)
```

**IMPORTANTE**: Para cuando hagamos la presentación/pdf estaría bien comentar (el profesor dijo que lo valorará positivamente) el proceso de investigación para saber que significa cada variable, yo por ahora (a parte de la página de Kaggle) he encontrado esto <https://github.com/FronkonGames/Steam-Games-Scraper>

**NOTA**: Esta no debería serla versión definitiva, creo que explicar 47 variables se nos va de tamño que flipas, lo he hecho por si os sirviera o por si al final si que dejamos la explicación de todas, en cualquier caso he hecho un drop de columnas que yo he creído que no ibamos a usar, una vez vayais acabando lo vuestro voy viendo a ver cuales usais


The dataset we will be working with contains a total number of 94948 observations and 47 columns or variables. The columns are described bellow:

-   **`appid`**: Unique idetnifier of the game on Steam. [num]
-   **`name`**: Name of the game. [text]
-   **`released_date``**: Represents the date where the game was released. [time]
-   **`required_age``**: Corresponds to the minimum age required to play the game. [num]
-   **`price`**: How much the game costs. If its 0 it means that the game is Free to Play. [num]
-   **`dlc_count`**: Ammount of DLCs (Downloadable Contents) the game has. [num]
-   **`detailed_description`**: Contains the detailed description of the game. [text]
-   **`about_the_game`**: Cointains information about the game. [text]
-   **`short_description`**: Provides a short descrpition of the game. [text]
-   **`reviews``**: Reviews given by professionals and its grades. [text]
-   **`header_image`**: Contains the URL to the header image of the game. [text]
-   **`website`**: Contains the URL to the official website of the game. [text]
-   **`suppport_url`**: URL to the support page of the game. [text]
-   **`support_email`**: Email of the game support team. [text]
-   **`windows`**: Determines if the game runs in windows. [categorical]
-   **`mac`**: Determines if the game runs in mac. [categorical]
-   **`linux`**: Determines if the game runs in linux. [categorical]
-   **`metacritic_score`**: Metacritic score based on critcical reviews (reviews from professionalss). By performing an investigation we think that an score of 0 means that when the scraping of the data was done there where no reviews for that game yet. [num]
-   **`metacritic_url`**: Metacritic's URL to the game. [text]
-   **`achievements`**: Number of achievements the game has. [num]
-   **`recommendations``**: Ammount of user recommendations. [num]
-   **`notes`**: Disclaimers about the game's content. [text]
-   **`supported_languages`**: List of languages that the game supports.[**NO SÉ QUE CATEGORÍA DARLE**]
-   **`full_audio_languages`**: List of languages with audio support for the game. [**LO MISMO QUE ARRIBA**]
-   **`packages`**: Avaliable packages for the game. It contains the name and a description of the package and the names, descriptions and subprices of the subpackages. [**LO MISMO QUE ARRIBA**]
-   **`Developers`**: List of developers associated with the game. [**LO MISMO QUE ARRIBA**]
-   **`publishers`**: List of publishers associated with the game. [**LO MISMO QUE ARRIBA**]
-   **`categories`**: List of categories that the game has. [**LO MISMO QUE ARRIBA**]
-   **`genres`**: List of genres that the game belongs to. [**LO MISMO QUE ARRIBA**]
-   **`screenshots`**: List of the game screenshots URLs. [**LO MISMO QUE ARRIBA**]
-   **`movies`**: List of the game moovies (videos) URLs. [**LO MISMO QUE ARRIBA**]
-   **`user_score`**: _Hay aprox 39 observaciones que NO son 0, no sé de dónde sale esto pero creo que se podría eliminar esta columna xd_
-   **`score_rank`**: Score rank of the games based on user reviews. _Pasa lo mismo que en user_socre, de hecho sólo los que tienen user_score tienen score_rank_
-   **`positive`**: Ammount of positive votes the game has. [num]
-   **`negative`**: Ammount of negative votes the game has. [num]
-   **`estimated_owners`**: Estimated owners of the game. [text]
-   **`average_playtime_forever`**: Average playtime since March 2009 measured in minutes. [num]
-   **`average_playtime_2weeks`**: Average playtime in the last two weeks measured in minutes. [num]
-   **`median_playtime_forever`**: Median playtime since March 2009 measured in minutes. [num]
-   **`median_playtime_2weeks`**: Median playtime in the last two weeks measured in minutes.[num]
-   **`discount`**: Discount the game has (in percentage). [num]
-   **`peak_ccu`**: Number of current users playing the day before the data was scrapped. [num]
-   **`tags`**: List of tags the game has with its name and its key. [**NO SE QUE CATEGORIA DARLE**]
-   **`pct_pos_total`**: Percentage of all reviews that are positive. [num]
-   **`num_reviews_total`**: Nummber of the total reviews the game has. [num]
-   **`pct_pos_recent`**: Percentage of the reviews made in the last 30 days that are positive. [num]
-   **`num_reviews_recent`**: Number of the reviews made in the last 30 days. [num]


```{r steam summary, echo = false}
summary(steam)
```


```{r removing columns, echo = FALSE}
first_cleaned_steam <- steam

first_cleaned_steam <- first_cleaned_steam %>% select(-detailed_description, -about_the_game, -short_description, -reviews, -header_image, -website, -support_url, -support_email, -metacritic_url, -notes, -full_audio_languages, -screenshots, -movies, -user_score, -score_rank, -discount, -pct_pos_recent, -num_reviews_recent)

str(first_cleaned_steam)
```

LOs juegos con número de reseñas = -1 creemos que son porque el scrappear ha fallado durante su ejecución. Si vamos a trabajar con las reseñas podríamos decir en la presentación que vamos a probar de volver a intentar scrappear la información 

Eliminar los juegos que tienen "Playtest" en su nombre

```{r removing playtest games, echo = FALSE}
second_cleaned_steam <- first_cleaned_steam %>%
  filter(!grepl("Playtest", name, ignore.case = TRUE))

summary(second_cleaned_steam)
```


Quitando juegos duplicados y juegos sin nombre
```{r}
# From the repeated games we keep with those that have the higher price and the higher amount of total reviews 
steam_unique_price <- second_cleaned_steam %>%
  arrange(name, desc(price), desc(num_reviews_total)) %>%
  group_by(name) %>%
  slice(1) %>%
  ungroup()

third_cleaned_steam <- steam_unique_price %>%
  filter(!is.na(name), name != "", name != " ")

str(third_cleaned_steam)
```


Removing estimated_owners column to create estimated_owners_min and estimated_owners_max
```{r handling estimated_owners, echo = FALSE}

add_range_minmax <- function(df, column, min_column, max_column) {
  column_quo <- enquo(column)

  df %>%
    mutate(
      "{min_column}" := as.integer(str_extract(!!column_quo, "^\\s*\\d+")),
      "{max_column}" := as.integer(str_extract(!!column_quo, "\\d+\\s*$"))
    )
}

fourth_cleaned_steam <- third_cleaned_steam %>%
  add_range_minmax(
    estimated_owners,
    "estimated_owners_min",
    "estimated_owners_max"
  )

fourth_cleaned_steam <- fourth_cleaned_steam %>% select(-estimated_owners) 

```



```{r pruebas mias, echo = FALSE}
## Checkeo de los score ranks y user_score para ver si estan relacionados
filtered_data <- steam %>% 
  filter(user_score > 0 & score_rank != 0)

filtered_data
str(filtered_data)

a <- steam %>% 
  filter(price >= 100)

a


filtered_data <- first_cleaned_steam %>% 
  filter(metacritic_score == 0)

(filtered_data)
```











# Can a signle game have enough influence to make other games have its tag?

```{r popularGames}

#buyedGames <- fourth_cleaned_steam[ fourth_cleaned_steam$estimated_owners_min >= 500000,]
buyedGames <- fourth_cleaned_steam
```
```{r get popular games}
popularGames <- buyedGames
popularGames$success <- as.numeric(as.Date("2025-03-01")-as.Date(popularGames$release_date))

#popularGames <-popularGames[popularGames$success >=1110,]
popularGames[popularGames$appid == 945360,]$tags
```

#TODO: merge this later, grabbed from Nahuel's code
```{r}
get_unique_dict_keys <- function(x) {
  x <- x[x != "[]"]
  
  keys_list <- str_extract_all(x, "(?<=')[^']+(?='\\s*:)")
  
  keys <- trimws(unlist(keys_list, use.names = FALSE))
  keys <- keys[keys != ""]
  sort(unique(keys))
}
```

#NOTE: 
while checking for "popular" games the amount of them was quite small
but if we consider unsuccesful games, the trends are much clearer

```{r}
  taggedGames <- popularGames %>% 
  filter(
    if_any(
      tags,
      ~ str_detect(.x, "Social Deduction")
    )
  )
  
  
  ref_date <- popularGames$release_date[popularGames$appid == 945360]
  taggedGames$date_diff <- round(as.numeric(
    as.Date(taggedGames$release_date) - as.Date(ref_date)
  )/30)
  trendPre <- taggedGames[taggedGames$date_diff < 0,]
  trendAft <- taggedGames[taggedGames$date_diff > 0,]
  
  freq_table <- as.data.frame(table(trendPre$date_diff))
  freq_table
  colnames(freq_table) <- c("date_diff", "freq")
  modelPre <- lm(freq ~ date_diff, data=freq_table)
  modelPre
  
  freq_table <- as.data.frame(table(trendAft$date_diff))
  colnames(freq_table) <- c("date_diff", "freq")
  freq_table
  modelAft <- lm(freq ~ date_diff, data=freq_table)
  modelAft
  plot(freq_table$date_diff, freq_table$freq, pch = 16, col = "black")
  abline(modelAft, col = "blue", lwd = 2)
```

```{r amongUs study}




amongUsLike <- popularGames %>% 
  filter(
    if_any(
      tags,
      ~ str_detect(.x, "Social Deduction")
    )
  )
amongUsLike
ref_date <- popularGames$release_date[popularGames$appid == 945360]

amongUsLike$date_diff <- round(as.numeric(
  as.Date(amongUsLike$release_date) - as.Date(ref_date)
)/30)
hist(
  amongUsLike$date_diff,
  breaks = "Sturges",
  main = "Frequency of Date Differences",
  xlab = "Difference (Months)",
  ylab = "Frequency",
  col = "lightgray",
  border = "white"
)


```

```{r slopeChangeDetector}
checkChangeInSlope <- function(games,tag, gamePoint){
  taggedGames <- games %>% 
  filter(
    if_any(
      tags,
      ~ str_detect(.x, tag)
    )
  )
  
  
  
  taggedGames$date_diff <- as.numeric(
    as.Date(taggedGames$release_date) - as.Date(gamePoint$release_date)
  )/30
  trendPre <- taggedGames[taggedGames$date_diff < 0,]
  trendAft <- taggedGames[taggedGames$date_diff > 0,]
  
  freq_table <- as.data.frame(table(trendPre$date_diff))
  colnames(freq_table) <- c("date_diff", "freq")
  

}
```

```{r single tag study}


```
