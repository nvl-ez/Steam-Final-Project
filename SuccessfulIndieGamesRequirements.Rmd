
```{r}
library(dplyr)
library(purrr)
library(stringr)
library(tidyr)
library(arules)
```


```{r}
steam <- read.csv("data/kaggle_march2025_full.csv")
```

# Create Dataset for this Section
Create helper function for extracting unique elements from entries with a list of values. All lists follow the same pattern: `['el1', 'el2',...]` being `[]` for empty lists.

```{r}
# Funcion helper 
get_unique_list_values <- function(x) {
  x <- x[x != "[]"]
  x <- gsub("^\\[|\\]$", "", x) # quitar [ y ]
  x <- gsub("['\"]", "", x)# quitar ' y "
  
  elements <- strsplit(x, ",") # dividr por comas

  vals <- trimws(unlist(elements, use.names = FALSE)) # aplanar y trim
  vals <- vals[vals != ""]
  
  sort(unique(vals))
}
```

Create helper function for extracting unique tags. These are formatted differently and follow dictionary-like pattern where each element is a key-value pair being `[]` for empty entries.
```{r}
get_unique_dict_keys <- function(x) {
  x <- x[x != "[]"]
  
  keys_list <- str_extract_all(x, "(?<=')[^']+(?='\\s*:)")
  
  keys <- trimws(unlist(keys_list, use.names = FALSE))
  keys <- keys[keys != ""]
  sort(unique(keys))
}
```


## Obtain Unique values for different columns
```{r}
steam_categories <- get_unique_list_values(steam$categories)
steam_categories
```
```{r}
steam_genres <- get_unique_list_values(steam$genres)
steam_genres
```


```{r}
steam_tags <- get_unique_dict_keys(steam$tags)
steam_tags
```
From steam's Categories, Genres and Tags, 3 subsets have been created with samples interesting for this study. Given steam's laxity at classifying these values, the 3 subsets have been created with our own interpretation. Additionally, tags that reffer to non-game software have been ignored.
```{r}
genres <- c(
  # Action
  "Action", "Action-Adventure", "Action RPG", "Action Roguelike", "Action RTS",
  "Arcade", "Immersive Sim", "Metroidvania", "Musou", "Sandbox", "Survival",
  "Survival Horror", "MOBA",

  # Shooter
  "Arena Shooter", "Battle Royale", "Boomer Shooter", "Bullet Hell", "Extraction Shooter",
  "FPS", "Hero Shooter", "Looter Shooter", "On-Rails Shooter", "Third-Person Shooter",
  "Top-Down Shooter", "Twin Stick Shooter", "Vehicular Combat", "Naval Combat",
  "Combat Racing",

  # Roguelike
  "Rogue-like", "Rogue-lite", "Roguevania", "Traditional Roguelike",
  "Roguelike Deckbuilder", "Mystery Dungeon",

  # RPG
  "RPG", "JRPG", "CRPG", "Strategy RPG", "Tactical RPG", "Otome", 
  "Dating Sim", "Visual Novel", "Interactive Fiction", "Text-Based", 
  "MMORPG", "MMO",

  # Strategy
  "Strategy", "4X", "Grand Strategy", "RTS", "Real Time Tactics",
  "Turn-Based Strategy", "Tactical", "Tabletop", "Wargame", "Political Sim",
  "God Game", "Management", "Colony Sim", "City Builder", "Shop Keeper",
  "Tower Defense", "Creature Collector",

  # Simulation
  "Simulation", "Automobile Sim", "Farming Sim", "Medical Sim",
  "Hobby Sim", "Life Sim", "Space Sim", "Outbreak Sim",

  # Sports
  "Sports", "Baseball", "Basketball", "Bowling", "Boxing", "BMX", "Cricket",
  "Football", "Football (American)", "Football (Soccer)", "Soccer",
  "Golf", "Hockey", "Mini Golf", "Motocross", "Pool", "Racing", "Rugby",
  "Skateboarding", "Skating", "Skiing", "Snowboarding", "Snooker", "Tennis",
  "Volleyball", "Wrestling", "Driving",

  # Fighting
  "2D Fighter", "3D Fighter", "Fighting", "Hack and Slash", "Souls-like",

  # Platformers & runners 
  "Platformer", "2D Platformer", "3D Platformer", "Precision Platformer",
  "Runner", "Open World Survival Craft",

  # Puzzle, logic, board & card games
  "Puzzle", "Puzzle-Platformer", "Logic", "Mahjong",
  "Match 3", "Tile-Matching", "Sokoban", "Solitaire", "Trivia",
  "Board Game", "Card Game", "Trading Card Game", "Hidden Object",
  "Escape Room", "Chess", "Word Game", "Point & Click",

  #  Casual / idle
  "Casual", "Idler", "Clicker", "Auto Battler", "Party Game", "Pinball",

  # Horror
  "Horror", "Psychological Horror",

  # Music & rhythm
  "Music", "Rhythm", "Typing",

  # Walking
  "Walking Simulator", "FMV"

)

mechanics <- c(
  # Economy, building, resources
  "Base-Building", "Building", "Resource Management", "Inventory Management",
  "Crafting", "Automation", "Mining", "Farming",
  
  # Customization
  "Gun Customization", "Character Customization",
  
  # Movement
  "Stealth", "Parkour", "Swordplay", "Archery", "Sniper",
  
  # Physics
  "Physics", "Destruction",
  
  # Failure
  "Permadeath", "Perma Death",
  
  # Procedural
  "Procedural Generation", "Music-Based Procedural Generation",
  
  # Timing
  "Turn-Based", "Turn-Based Combat", "Turn-Based Tactics",
  "Real-Time", "Real-Time with Pause",
  "Time Manipulation", "Time Management", "Time Attack",
  
  # Spatial rules
  "Grid-Based Movement", "Hex Grid",
  
  # QTE
  "Quick-Time Events",
  
  # Narrative logic
  "Choices Matter", "Multiple Endings", "Nonlinear",
  
  # Exploration & structure
  "Exploration", "Dungeon Crawler", "Collectathon",
  "Boss Rush", "Side Scroller", "Loot", 
  
  # Social deduction
  "Social Deduction",
  
  # Card/Deck mechanics
  "Deckbuilding", "Card Battler",
  
  # Programming
  "Programming", "Coding",
  
  # Economy
  "Trading", "Economy", "Capitalism",
  "Diplomacy",
  
  # Modding / creation
  "Level Editor", "Moddable", "Mod",
  
  # Tutorial
  "Tutorial"
)

characteristics <- c(
  # Dimensionality & camera
  "2D", "2.5D", "3D",
  "Isometric", "Top-Down",
  "6DOF",
  "First-Person", "Third Person",
  
  # VR
  "VR", "VR Only", "Asymmetric VR",
  
  # Player count / mode
  "Singleplayer",
  "Multiplayer", "Massively Multiplayer",
  "Co-op", "Local Co-Op", "Online Co-Op", "Co-op Campaign",
  "4 Player Local", "Split Screen",
  
  # Team/role structure
  "PvP", "PvE", "Team-Based",
  "Asynchronous Multiplayer",
  
  # Competitive/e-sports
  "e-sports"
)
```


Thankfully the task of filtering indie games is already provided by steam with the Tags and Genres Indie, Crowfunded and Kickstarter. From the original dataset, only Indie games are obtained.
```{r}
indie <- c("Crowdfunded", "Kickstarter", "Indie")
indie_pattern <- str_c(indie, collapse = "|")

indie_games <- steam %>% 
  filter(
    if_any(
      c(categories, genres, tags),
      ~ str_detect(.x, indie_pattern)
    )
  )
```

Prepare data for determining successful games TODO
```{r}
indie_games_data <- indie_games %>% select(appid, name, price, dlc_count, windows, mac, linux, achievements, recommendations, supported_languages, user_score, score_rank, positive, negative, estimated_owners, average_playtime_forever, average_playtime_2weeks, median_playtime_forever, median_playtime_2weeks, peak_ccu, pct_pos_total, num_reviews_total, pct_pos_recent, num_reviews_recent)
```





Helper function for generating the one-hot encoded variables for the genres, characteristics and mechanics:
```{r}
make_one_hot <- function(data, values, categories_col = "categories", genres_col = "genres", tags_col = "tags") {
  
  # Modified version of get_unique_list_values
  parse_list_row <- function(x) {
    if (x == "[]") return(character(0))
    
    x <- gsub("^\\[|\\]$", "", x) # quitar [ y ]
    x <- gsub("['\"]", "", x)     # quitar ' y "
    
    elements <- strsplit(x, ",")[[1]]
    vals <- trimws(elements)
    vals <- vals[vals != ""]
    vals
  }
  
  # Modified version of get_unique_dict_keys
  parse_dict_row <- function(x) {
    if (x == "[]" || x == "") return(character(0))
    
    m <- gregexpr("'[^']+'(?='\\s*:)", x, perl = TRUE)
    keys <- regmatches(x, m)[[1]]
    if (length(keys) == 0) return(character(0))
    
    keys <- gsub("^'|'$", "", keys)
    keys <- trimws(keys)
    keys[keys != ""]
  }
  
  # Precompute  tokens per game (categories + genres + tags)
  tokens_list <- lapply(seq_len(nrow(data)), function(i) {
    cats <- parse_list_row(data[[categories_col]][i])
    gens <- parse_list_row(data[[genres_col]][i])
    tgs  <- parse_dict_row(data[[tags_col]][i])
    
    unique(c(cats, gens, tgs))
  })
  
  # For each  value, create a one-hot column
  for (val in values) {
    data[[val]] <- vapply(
      tokens_list,
      function(tokens) val %in% tokens,
      logical(1)
    )
  }
  
  data
}
```

From the indie_games dataset, only the valuable variables for our study will be kept
```{r}
# Reduce
indie_games_data <- indie_games %>% select(appid, name, price, dlc_count, windows, mac, linux, achievements, recommendations, supported_languages, user_score, score_rank, positive, negative, estimated_owners, average_playtime_forever, average_playtime_2weeks, median_playtime_forever, median_playtime_2weeks, peak_ccu, pct_pos_total, num_reviews_total, pct_pos_recent, num_reviews_recent)

indie_games_attributes <- indie_games %>% select(tags, categories, genres)

indie_games_genre <- indie_games_attributes %>% 
  make_one_hot(genres) %>% 
  select(-tags, -categories, -genres) %>% 
  as("transactions")

indie_games_mechanics <- 
  indie_games_attributes %>% 
  make_one_hot(mechanics) %>% 
  select(-tags, -categories, -genres) %>% 
  as("transactions")

indie_games_characteristics <- 
  indie_games_attributes %>% 
  make_one_hot(characteristics) %>% 
  select(-tags, -categories, -genres) %>% 
  as("transactions")

```
